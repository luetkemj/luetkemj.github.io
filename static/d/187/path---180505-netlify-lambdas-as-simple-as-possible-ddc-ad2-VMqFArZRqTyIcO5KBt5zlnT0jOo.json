{"data":{"site":{"siteMetadata":{"title":"luetkemj","description":"Change Is Good","author":"mark luetke"}},"markdownRemark":{"excerpt":"I could wax poetic about the wonder that is  Netlify  or I could get to the point. Let's get to the point. Netlify does a wonderful job of…","html":"<p>I could wax poetic about the wonder that is <a href=\"https://www.netlify.com/\">Netlify</a> or I could get to the point.</p>\n<p>Let's get to the point.</p>\n<p>Netlify does a wonderful job of running your build script and deploying your site. So good in fact it is difficult at times to know where Netlify's magic begins and ends. While messing around with Lambda functions on Netlify I found myself struggling to get a successful build going. With so much of the process abstracted away I found it difficult to modify my approach in any meaningful way.</p>\n<p>Why was I having problems? Was my build script configuration buggered up? Were the settings on my Netlify account borked? Did I write my .toml file correctly? When exactly does Netlify deploy my functions and where exactly is it looking for them? Does it build them? Do I build them? Do I have to use their <a href=\"https://www.npmjs.com/package/netlify-lambda\">build tool?</a></p>\n<p>In the end I found that the best approach to take in order to grok things was a simple one.</p>\n<p>As simple as possible.</p>\n<p>This is not a complex tutorial. This is also not a tutorial aimed at beginners. It is simply an attempt to strip away all the complexities of modern web development in a concerted effort to focus on the singular problem at hand — understanding how Netlify deploys Lambda functions.</p>\n<p>What follows is the most minimal approach to successfully deploy an AWS Lambda on Netlify I could come up with.</p>\n<h3>UPDATE 180509</h3>\n<p>Project structure and build step has been updated in response to Phil Hawksworth's comment below. While everything worked as initially structured it is bad practice to put your production ready lambdas in your publish folder. Once you start making API calls to protected services that require secrets you are opening  up security holes by publishing your lambdas (and potentially secrets) client side.</p>\n<p>Thanks for the catch Phil!</p>\n<p><a href=\"https://github.com/luetkemj/test-netlify-lambdas/tree/simple\">Skip to the code on github.</a></p>\n<h3>Setting up the project</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># create a directory structure for our project\nmkdir -p simple-lambdas/src/functions\n\n# navigate to our new project\ncd simple-lambdas\n\n# create a package.json file with npm - just accept all the defaults.\nnpm init</code></pre></div>\n<p>Your project structure should look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">simple-lambdas\n  - package.json\n  - src\n    - functions</code></pre></div>\n<h3>A simple function</h3>\n<p>Netlify does a <a href=\"https://www.netlify.com/docs/functions/#javascript-lambda-functions\">good job of explaining</a> how a Lambda function should be structured.</p>\n<p>Create a file in <code class=\"language-text\">src/functions</code> named <code class=\"language-text\">hello.js</code> and paste Netlify's simple example function into it:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">exports.handler = function(event, context, callback) {\n  callback(null, {\n    statusCode: 200,\n    body: &quot;Hello, World&quot;\n  });\n}</code></pre></div>\n<p>Netlify deploys your Lambda functions <em>AFTER</em> the build step.</p>\n<p><em>You must have a build step</em>.</p>\n<p>Build steps can get complicated real fast with things like webpack, babel, etc. So we'll sort of fake it by copying our functions dir from <code class=\"language-text\">./src</code> to our project root at <code class=\"language-text\">./functions</code> and making an empty <code class=\"language-text\">./dist</code> dir we can point netlify at for our publish folder.</p>\n<p>Add this script to your package.json:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&quot;build&quot;: &quot;rm -rf dist &amp;&amp; rm -rf functions &amp;&amp; cp -r src/functions functions &amp;&amp; mkdir dist&quot;</code></pre></div>\n<p>Your package.json should now look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  &quot;name&quot;: &quot;simple-lambdas&quot;,\n  &quot;version&quot;: &quot;1.0.0&quot;,\n  &quot;description&quot;: &quot;&quot;,\n  &quot;main&quot;: &quot;index.js&quot;,\n  &quot;scripts&quot;: {\n    &quot;build&quot;: &quot;rm -rf dist &amp;&amp; rm -rf functions &amp;&amp; cp -r src/functions functions &amp;&amp; mkdir dist&quot;\n  },\n  &quot;author&quot;: &quot;&quot;,\n  &quot;license&quot;: &quot;ISC&quot;\n}</code></pre></div>\n<p><code class=\"language-text\">npm run build</code> will delete <code class=\"language-text\">./dist</code> and <code class=\"language-text\">./functions</code> if they already exist, make a copy of <code class=\"language-text\">./src/functions</code> to <code class=\"language-text\">./functions</code> and make a new empty dir at <code class=\"language-text\">./dist</code>.</p>\n<p>Finally, we need to tell Netlify how our project is structured. This can be done from their web interface but in this tutorial we will create a special settings file that will override those settings.</p>\n<p>Create a file called <code class=\"language-text\">netlify.toml</code> in the root of your project with the following contents:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[build]\n  command = &quot;npm run build&quot; # your build command\n  publish = &quot;./dist&quot; # where your production ready code lives AFTER your build command has run\n  functions = &quot;./functions&quot; # where your production ready lambda functions live AFTER your build command has run</code></pre></div>\n<p>Every root file in <code class=\"language-text\">./functions</code> will become an endpoint with the following structure:</p>\n<p><code class=\"language-text\">{your-site-root}/.netlify/functions/{filename}</code></p>\n<p>to see it in action deploy the project to Netlify and navigate to:</p>\n<p><code class=\"language-text\">{your-site-root}/.netlify/functions/hello</code></p>\n<p>In the end Netlify does surprising little with your project. It runs the build command you tell it to, publishes the production code from the directory you tell it to, and packages and deploys functions from the directory you tell it to. What happens in your build step is entirely up to <strong>you</strong>. Where you put your production ready code and Lambda functions is entirely up to <strong>you</strong>.</p>\n<p>With this simple understanding, complexity may flourish.</p>","frontmatter":{"date":"180505","title":"Netlify Lambdas - As Simple As Possible","illustration":null,"layout":"post"}},"allFile":{"edges":[{"node":{"relativePath":"luetkemj.png","publicURL":"/static/luetkemj-1831991e0e0c9cc03aa10eca078afa54.png"}}]},"nextPost":{"edges":[{"node":{"path":"/170902/experiencing-flow"}}]},"nextPostMarkdown":{"frontmatter":{"title":"Experiencing Flow"}},"previousPost":null,"previousPostMarkdown":null},"pageContext":{"nextPostPath":"/170902/experiencing-flow","previousPostPath":null}}